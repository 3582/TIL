---
title: "データベースからのデータを返すPHP APIの作成"
emoji: "🕌"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["php"]
published: false
---
## 目的:PHPでAPIエンドポイントを作成する方法を学ぶ

- データベースからデータを取得し、JSON形式で返す方法を理解する。

### 課題詳細

- PHPでAPIエンドポイントを作成する方法を学ぶ。
- PostgreSQLデータベースからデータを取得し、JSON形式で返す方法を理解する。

```sql
CREATE DATABASE til_db;
\c til_db;

CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  email VARCHAR(100) NOT NULL
);

INSERT INTO users (name, email) VALUES ('John Doe', 'john@example.com'), ('Jane Smith', 'jane@example.com');
```

1. データベースのセットアップ
2. PHPスクリプトの作成:データベースに接続し、usersテーブルからデータを取得してJSON形式で返すPHPスクリプトを作成してください

- データベース接続にはPDOを使用すると良いでしょう。
- エラーハンドリングを実装して、接続エラーやクエリエラーの場合に適切なメッセージを返すようにします。
- Content-Typeヘッダーを設定して、JSON形式でデータを返します。

1. api.phpという名前で上記のPHPスクリプトを作成します。
2. ウェブサーバーを使用してPHPスクリプトをホストします。
3. ブラウザまたはAPIクライアント（例：Postman）を使用して、<http://localhost/api.php>にアクセスし、JSON形式でユーザーのデータが返されることを確認します

### 参考文献

- [PHP: PDO - Manual](https://www.php.net/manual/ja/book.pdo.php)
- [PostgreSQL: Documentation](https://www.postgresql.org/docs/)
- [PHP: JSON - Manual](https://www.php.net/manual/ja/book.json.php)
- [Nginx Documentation](https://nginx.org/en/docs/)
- [Using Nginx with PHP](https://www.nginx.com/resources/wiki/start/topics/examples/phpfastcgi/)

### 注意点

- 実際の運用では、データベース接続情報（ユーザー名やパスワード）をハードコーディングするのではなく、環境変数や設定ファイルから取得することが推奨されます。
- エラーメッセージには機密情報が含まれる可能性があるため、公開されないように適切に処理することが重要です。

### php

```php
<?php
header('Content-Type: application/json');

$dsn = 'pgsql:host=localhost;port=5432;dbname=til_db;';
$username = 'your_postgres_username'; // PostgreSQLのユーザー名
$password = 'your_postgres_password'; // PostgreSQLのパスワード

try {
    $pdo = new PDO($dsn, $username, $password);
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);

    $stmt = $pdo->query('SELECT id, name, email FROM users');
    $users = $stmt->fetchAll(PDO::FETCH_ASSOC);

    echo json_encode($users);
} catch (PDOException $e) {
    http_response_code(500);
    echo json_encode(['error' => $e->getMessage()]);
}
```
