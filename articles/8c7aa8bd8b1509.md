---
title: "Docker Composeã‚’ä½¿ç”¨ã—ãŸPHP APIã¨PostgreSQLã®æ§‹æˆ (PostgreSQL)"
emoji: "ğŸ£"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["php"]
published: false
---
### èª²é¡Œè©³ç´°

- Docker Composeã‚’ä½¿ã£ã¦PHPã¨PostgreSQLã®ç’°å¢ƒã‚’ç°¡å˜ã«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹ã€‚
- Dockerã‚’ä½¿ã£ãŸã‚³ãƒ³ãƒ†ãƒŠåŒ–ã®åŸºç¤ã‚’ç†è§£ã™ã‚‹ã€‚
- PHPã§APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹æ–¹æ³•ã‚’å­¦ã¶ã€‚
- PostgreSQLãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã€JSONå½¢å¼ã§è¿”ã™æ–¹
æ³•ã‚’ç†è§£ã™ã‚‹ã€‚

1. Docker Composeãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
2. nginx.confãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
3. PHPã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä½œæˆ

- ã‚¦ã‚§ãƒ–ã‚µãƒ¼ãƒãƒ¼ã‚’ä½¿ç”¨ã—ã¦PHPã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ãƒ›ã‚¹ãƒˆã—ã¾ã™ã€‚
- ãƒ–ãƒ©ã‚¦ã‚¶ã¾ãŸã¯APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆä¾‹ï¼šPostmanï¼‰ã‚’ä½¿ç”¨ã—ã¦ã€<http://localhost/api.php>ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€JSONå½¢å¼ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

### å‚è€ƒæ–‡çŒ®

- [Docker Compose Documentation](https://docs.docker.com/compose/)
- [Nginx: Documentation](https://nginx.org/en/docs/)
- [PostgreSQL Documentation](https://www.postgresql.org/docs/)
- [PHP PDO Documentation](https://www.php.net/manual/en/book.pdo.php)
- [PHP-FPM: Documentation](https://www.php.net/manual/en/install.fpm.php)

#### å‹•ä½œç¢ºèª

- ã‚³ãƒ³ãƒ†ãƒŠã®èµ·å‹•

```sh
docker-compose up -d
```

- ãƒ–ãƒ©ã‚¦ã‚¶ã¾ãŸã¯APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆä¾‹ï¼šPostmanï¼‰ã‚’ä½¿ç”¨ã—ã¦ã€`http://localhost/api.php`ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€JSONå½¢å¼ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

#### `docker-compose.yml` ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ

```yaml
version: '3.8'

services:
  web:
    image: php:8.1-fpm
    container_name: php-fpm
    volumes:
      - ./src:/var/www/html
    depends_on:
      - db

  nginx:
    image: nginx:latest
    container_name: nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./src:/var/www/html
    depends_on:
      - web

  db:
    image: postgres:latest
    container_name: postgres
    environment:
      POSTGRES_DB: til_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: example
    volumes:
      - pgdata:/var/lib/postgresql/data

volumes:
  pgdata:
```

#### `nginx.conf` ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ

```nginx
server {
    listen 80;
    server_name localhost;
    root /var/www/html;
    index index.php;

    location / {
        try_files $uri $uri/ =404;
    }

    location ~ \.php$ {
        fastcgi_pass web:9000;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    }

    location ~ /\.ht {
        deny all;
    }
}
```

#### PHPã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä½œæˆ

`src/api.php`:

```php
<?php
header('Content-Type: application/json');

$dsn = 'pgsql:host=db;port=5432;dbname=til_db;';
$username = 'postgres'; // PostgreSQLã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å
$password = 'example'; // PostgreSQLã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰

try {
    $pdo = new PDO($dsn, $username, $password);
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);

    $stmt = $pdo->query('SELECT id, name, email FROM users');
    $users = $stmt->fetchAll(PDO::FETCH_ASSOC);

    echo json_encode($users);
} catch (PDOException $e) {
    http_response_code(500);
    echo json_encode(['error' => $e->getMessage()]);
}
```

#### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®åˆæœŸãƒ‡ãƒ¼ã‚¿è¨­å®š

`src/init.sql`:

```sql
CREATE TABLE IF NOT EXISTS users (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(100) NOT NULL
);

INSERT INTO users (name, email) VALUES 
('John Doe', 'john@example.com'),
('Jane Smith', 'jane@example.com');
```

æ¬¡ã«ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã“ã®SQLãƒ•ã‚¡ã‚¤ãƒ«ã‚’é©ç”¨ã™ã‚‹ãŸã‚ã«ã€`docker-compose.yml`ã«ä»¥ä¸‹ã®è¨­å®šã‚’è¿½åŠ ã—ã¾ã™ã€‚

```yaml
services:
  db:
    ...
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./src/init.sql:/docker-entrypoint-initdb.d/init.sql
```
